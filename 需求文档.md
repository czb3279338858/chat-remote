# 需求文档：通用移动端远程交互系统

## 1. 项目背景与目标
### 1.1 背景
用户在移动办公或非电脑旁场景下，无法通过移动设备直接操控 PC 端的工具或执行指令。目前首要需求是远程使用 `qoder-cli`，但长期目标是建立一个通用的控制通道。

### 1.2 目标
构建一个通用的远程交互系统，以聊天软件（首期飞书）作为交互界面，实现移动端对 PC 端多种执行目标（Job 模式与 Session 模式）的指令下发、交互输入与结果回显。

## 2. 核心用户角色
*   **授权操作者**：拥有特定唯一用户 ID 且在信任名单内的用户，支持在私聊或群聊场景下远程操控 PC 端。

## 3. 核心业务流程
1.  **指令发送（带上下文）**：授权用户在聊天界面输入消息。
    *   **启动指令**：触发新实例创建（支持自定义别名与备注）。
    *   **交互输入**：对处于 Session 模式（如 Shell, REPL）的实例，后续消息自动路由为其实际进程的标准输入（stdin）。
2.  **身份校验与中转**：系统识别 **用户 ID**，非授权用户指令直接忽略（静默处理）。通过校验后，将消息及 **Context ID**（会话/群组标识）传输至 PC 端。
3.  **智能路由与分发**：
    *   **Context 感知**：根据 Context ID 匹配对应插件实例。
    *   **交互映射**：消息根据路由逻辑精准投递给目标进程的输入流。
4.  **异步并行执行与会话维持**：各实例独立运行。系统负责维持 Session 实例的生命周期，支持长驻交互。
5.  **精准路由反馈**：执行输出（stdout/stderr）携带 Context ID，确保准确回复到触发该消息的原始会话中。

## 4. 功能要点（业务维度）
*   **双向高可扩展架构**：
    *   **交互端（Frontend）**：统一消息输入接口，首期飞书，未来支持微信、钉钉等。
    *   **执行端（Backend）**：统一执行输出接口，支持 `qoder-cli`、系统 Shell、自定义脚本等。
*   **智能多实例会话管理**：
    *   **身份自定义**：用户在创建实例时分配 **自定义别名（Alias）** 和 **业务备注（Remark）**。
    *   **分级交互策略（保底与增强）**：
        *   **保底方案**：通过 `别名: 指令` 进行显式路由（适用于所有平台）。
        *   **体验增强**：在支持的平台上支持“回复即指定”（引用回复消息自动路由）。
        *   **智能兜底**：无指定时默认路由至最后活跃实例。
    *   **识别与清单**：回传消息强制带有 `[别名]` 标记；通过 `/list` 查看所有活跃实例及其当前任务耗时（若正在执行）、备注。
*   **指令精准路由**：支持基于“上下文 ID + 指令内容”的复合路由逻辑。
*   **即时交互体验（可视化状态流）**：
    *   **关键节点回执**：仅在“已送达、开始执行、执行结束、执行异常”等节点主动推送，避免消息噪音。
    *   **被动监控模式（Passive Mode）**：长耗时任务静默执行。用户通过 `/list` 主动查询时，重点反馈当前任务的已执行时长。
    *   **超长响应处理**：系统自动执行 **分片发送**，按序添加索引标记（如 `[1/3]`），确保完整内容送达。
    *   **多态异常提醒**：优先使用红色警示（富文本卡片）或语义化 Emoji（❌、⚠️）前缀。

## 5. 业务约束与安全规则
*   **严格用户 ID 授权（核心安全）**：
    *   **认人不认群**：仅响应受信任用户 ID 的指令。群聊中非授权用户操作机器人，系统保持静默。
*   **双向抽象标准**：
    *   **统一协议**：消息包必须封装 `Content`、`UserID` 和 `ContextID`。
    *   **统一契约**：执行结果必须能回溯其触发上下文，支持 stdout 分片输出。
*   **反馈格式适配**：业务层负责适配不同平台的长度限制与展示能力（分片逻辑、符号化标识）。
